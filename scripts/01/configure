#!/bin/bash
# configure - Detect hardware capabilities and generate build configuration

set -e

echo "=== Neoverse Optimization Tutorial Configuration ==="
echo

# Detect CPU information
CPU_INFO=$(lscpu)
CPU_MODEL=$(echo "$CPU_INFO" | grep "Model name" | cut -d: -f2 | xargs)
CPU_ARCH=$(echo "$CPU_INFO" | grep "Architecture" | cut -d: -f2 | xargs)
CPU_CORES=$(echo "$CPU_INFO" | grep "^CPU(s):" | cut -d: -f2 | xargs)

echo "Detected Hardware:"
echo "  CPU Model: $CPU_MODEL"
echo "  Architecture: $CPU_ARCH"
echo "  CPU Cores: $CPU_CORES"
echo

# Detect Neoverse processor type
NEOVERSE_TYPE="unknown"
if echo "$CPU_MODEL" | grep -qi "neoverse.*n1"; then
    NEOVERSE_TYPE="n1"
elif echo "$CPU_MODEL" | grep -qi "neoverse.*n2"; then
    NEOVERSE_TYPE="n2"
elif echo "$CPU_MODEL" | grep -qi "neoverse.*v1"; then
    NEOVERSE_TYPE="v1"
elif echo "$CPU_MODEL" | grep -qi "neoverse.*v2"; then
    NEOVERSE_TYPE="v2"
fi

echo "Neoverse Type: $NEOVERSE_TYPE"

# Detect available features
FEATURES_FILE="/proc/cpuinfo"
HAS_NEON=$(grep -q "asimd" $FEATURES_FILE && echo "YES" || echo "NO")
HAS_SVE=$(grep -q "sve" $FEATURES_FILE && echo "YES" || echo "NO")
HAS_SVE2=$(grep -q "sve2" $FEATURES_FILE && echo "YES" || echo "NO")
HAS_LSE=$(grep -q "atomics" $FEATURES_FILE && echo "YES" || echo "NO")
HAS_CRYPTO=$(grep -q "aes\|sha1\|sha2" $FEATURES_FILE && echo "YES" || echo "NO")

echo
echo "Available Features:"
echo "  NEON (Advanced SIMD): $HAS_NEON"
echo "  SVE: $HAS_SVE"
echo "  SVE2: $HAS_SVE2"
echo "  LSE Atomics: $HAS_LSE"
echo "  Crypto Extensions: $HAS_CRYPTO"

# Detect SVE vector length if available
SVE_VL="0"
if [ "$HAS_SVE" = "YES" ]; then
    # Try to detect SVE vector length
    if command -v getconf >/dev/null 2>&1; then
        SVE_VL=$(getconf LEVEL1_DCACHE_LINESIZE 2>/dev/null || echo "128")
    fi
    echo "  SVE Vector Length: ${SVE_VL} bits"
fi

echo

# Generate CMake configuration
cat > CMakeCache.txt << EOL
# Generated by configure script
CMAKE_BUILD_TYPE:STRING=Release
CMAKE_C_COMPILER:FILEPATH=/usr/bin/gcc-11
CMAKE_CXX_COMPILER:FILEPATH=/usr/bin/g++-11

# Hardware detection results
NEOVERSE_TYPE:STRING=$NEOVERSE_TYPE
CPU_CORES:STRING=$CPU_CORES
HAS_NEON:BOOL=$HAS_NEON
HAS_SVE:BOOL=$HAS_SVE
HAS_SVE2:BOOL=$HAS_SVE2
HAS_LSE:BOOL=$HAS_LSE
HAS_CRYPTO:BOOL=$HAS_CRYPTO
SVE_VL:STRING=$SVE_VL
EOL

echo "Configuration complete!"
echo "Generated CMakeCache.txt with detected hardware capabilities."
echo
echo "Step 3 Complete: Hardware detection finished!"
echo
echo "Setup Summary:"
echo "  Dependencies installed and verified"
echo "  Project structure created"
echo "  Hardware capabilities detected"
echo "  Build configuration generated"
echo
echo "Ready to proceed with the Neoverse optimization tutorial!"
echo "Next: Continue with 02-hardware-detection.md"
